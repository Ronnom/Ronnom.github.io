<?php 
session_start();
define('ACCESS_ALLOWED', true); 
require_once '../config/db_connect.php';

// 1. ACCESS CONTROL (Only Admin & HR)
if (!isset($_SESSION['user_id']) || ($_SESSION['role'] !== 'admin' && $_SESSION['role'] !== 'hr')) {
    echo "Access Denied"; exit;
}

// 2. FETCH EMPLOYEES FOR DROPDOWN
$empQ = $conn->query("SELECT id, full_name FROM users ORDER BY full_name ASC");

// 3. FETCH LOGS (Filter Logic)
$dateFilter = $_GET['date'] ?? date('Y-m-d');
$userFilter = $_GET['user_id'] ?? 'All';

$whereSQL = "WHERE date = '$dateFilter'";
if($userFilter !== 'All') { $whereSQL .= " AND user_id = $userFilter"; }

$sql = "SELECT a.*, u.full_name FROM attendance_logs a JOIN users u ON a.user_id = u.id $whereSQL ORDER BY u.full_name ASC";
$logs = $conn->query($sql);
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HR Attendance View</title>
    <link rel="icon" type="image/png" href="../assets/img/logopc.png">
    <link href="../fontawesome/css/all.min.css" rel="stylesheet">
    <script src="../assets/js/main.js?v=2"></script>
    <link rel="stylesheet" href="../assets/css/style.css?v=<?php echo time(); ?>">
    <style>
        /* MATCHING YOUR DRAWING STYLE */
        .log-card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .employee-header { font-size: 18px; font-weight: 800; color: #2b3674; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        .circles-container { display: flex; justify-content: space-around; align-items: center; gap: 20px; flex-wrap: wrap; }
        
        .circle-item { display: flex; flex-direction: column; align-items: center; width: 120px; }
        
        .photo-circle { 
            width: 100px; height: 100px; 
            border-radius: 50%; 
            border: 3px solid #e0e7ff; 
            background: #f4f7fe;
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 10px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .photo-circle:hover { transform: scale(1.1); border-color: #476eef; }
        .photo-circle img { width: 100%; height: 100%; object-fit: cover; }
        .photo-circle i { font-size: 30px; color: #a3aed0; }

        .time-label { font-size: 11px; font-weight: 700; color: #a3aed0; text-transform: uppercase; }
        .time-value { font-size: 14px; font-weight: 800; color: #2b3674; }
        
        .filters { display: flex; gap: 15px; margin-bottom: 20px; background: white; padding: 15px; border-radius: 12px; }
        .form-select, .form-input { padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; }
    </style>
</head>
<body>

    <?php include '../includes/sidebar.php'; ?>

    <main class="main-content">
        <header>
            <div><h2>Attendance History</h2></div>
        </header>

        <form class="filters">
            <input type="date" name="date" class="form-input" value="<?php echo $dateFilter; ?>">
            <select name="user_id" class="form-select">
                <option value="All">All Employees</option>
                <?php while($row = $empQ->fetch_assoc()): ?>
                    <option value="<?php echo $row['id']; ?>" <?php if($userFilter == $row['id']) echo 'selected'; ?>>
                        <?php echo htmlspecialchars($row['full_name']); ?>
                    </option>
                <?php endwhile; ?>
            </select>
            <button type="submit" class="btn-save" style="padding: 10px 20px;">Filter</button>
        </form>

        <?php if($logs->num_rows > 0): ?>
            <?php while($data = $logs->fetch_assoc()): ?>
                <div class="log-card">
                    <div class="employee-header">
                        <?php echo htmlspecialchars($data['full_name']); ?> 
                        <span style="font-size:12px; font-weight:normal; color:#a3aed0; float:right;">Total: <?php echo $data['total_hours']; ?> hrs</span>
                    </div>
                    
                    <div class="circles-container">
                        
                        <div class="circle-item">
                            <div class="photo-circle" onclick="viewPhoto('<?php echo $data['time_in_img']; ?>')">
                                <?php if($data['time_in_img']): ?>
                                    <img src="../assets/attendance_uploads/<?php echo $data['time_in_img']; ?>">
                                <?php else: ?>
                                    <i class="fa-solid fa-user"></i>
                                <?php endif; ?>
                            </div>
                            <span class="time-label">Time In</span>
                            <span class="time-value"><?php echo $data['time_in'] ? date("h:i A", strtotime($data['time_in'])) : "--:--"; ?></span>
                        </div>

                        <div class="circle-item">
                            <div class="photo-circle" onclick="viewPhoto('<?php echo $data['break_out_img']; ?>')">
                                <?php if($data['break_out_img']): ?>
                                    <img src="../assets/attendance_uploads/<?php echo $data['break_out_img']; ?>">
                                <?php else: ?>
                                    <i class="fa-solid fa-mug-hot"></i>
                                <?php endif; ?>
                            </div>
                            <span class="time-label">Break Out</span>
                            <span class="time-value"><?php echo $data['break_out'] ? date("h:i A", strtotime($data['break_out'])) : "--:--"; ?></span>
                        </div>

                        <div class="circle-item">
                            <div class="photo-circle" onclick="viewPhoto('<?php echo $data['time_out_img']; ?>')">
                                <?php if($data['time_out_img']): ?>
                                    <img src="../assets/attendance_uploads/<?php echo $data['time_out_img']; ?>">
                                <?php else: ?>
                                    <i class="fa-solid fa-right-from-bracket"></i>
                                <?php endif; ?>
                            </div>
                            <span class="time-label">Time Out</span>
                            <span class="time-value"><?php echo $data['time_out'] ? date("h:i A", strtotime($data['time_out'])) : "--:--"; ?></span>
                        </div>

                    </div>
                </div>
            <?php endwhile; ?>
        <?php else: ?>
            <div style="text-align:center; padding:40px; color:#a3aed0;">No attendance records found for this date.</div>
        <?php endif; ?>

    </main>

    <div id="photoModal" class="modal" onclick="this.style.display='none'">
        <div class="modal-content" style="width: auto; max-width: 500px; background: transparent; box-shadow: none; border: none; text-align: center;">
            <img id="modalImg" src="" style="border-radius: 12px; border: 5px solid white; max-width: 100%;">
        </div>
    </div>

    <script>
        function viewPhoto(filename) {
            if(!filename) return;
            document.getElementById('modalImg').src = "../assets/attendance_uploads/" + filename;
            document.getElementById('photoModal').style.display = 'flex';
        }
    </script>
</body>
</html>